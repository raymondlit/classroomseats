<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教室座位安排系统 - 终极版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --primary-color: #e6f2ff;
            --secondary-color: #b3d9ff;
            --accent-color: #4da6ff;
            --text-color: #333;
            --border-color: #99ccff;
            --desk-color: #d9e6ff;
            --hover-color: #cce5ff;
            --disabled-color: #f0f0f0;
            --font-family: 'Microsoft YaHei', sans-serif;
            --font-size: 14px;
            --header-font-size: 1.5em;
            --section-font-size: 1.2em;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-family);
            background-color: #f0f8ff;
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            font-size: var(--font-size);
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, var(--accent-color), #66b3ff);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: var(--header-font-size);
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            min-height: 700px;
        }
        
        .control-panel {
            background-color: var(--primary-color);
            padding: 20px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .seat-display {
            padding: 20px;
            background-color: white;
            overflow: auto;
            flex-grow: 1;
        }
        
        .panel-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .section {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        h2 {
            color: var(--accent-color);
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--secondary-color);
            font-size: var(--section-font-size);
        }
        
        textarea, input, select, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: var(--font-size);
            font-family: var(--font-family);
        }
        
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            padding: 12px;
        }
        
        button:hover {
            background-color: #3385ff;
        }
        
        .row-config {
            display: flex;
            gap: 10px;
        }
        
        .row-config input {
            flex: 1;
        }
        
        .area-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .area-config input {
            margin-bottom: 0;
        }
        
        .classroom-container {
            position: relative;
            margin: 0 auto;
            max-width: 100%;
            overflow: auto;
        }
        
        .classroom {
            display: grid;
            gap: 15px;
            padding: 25px;
            background-color: var(--primary-color);
            border-radius: 8px;
            margin: 0 auto;
            transition: all 0.3s ease;
        }
        
        .seat {
            background-color: var(--desk-color);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 10px;
            text-align: center;
            cursor: grab;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            min-width: 110px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .seat:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.15);
            background-color: var(--hover-color);
        }
        
        .seat.dragging {
            opacity: 0.8;
            box-shadow: 0 0 15px rgba(77, 166, 255, 0.9);
            cursor: grabbing;
        }
        
        .seat.drop-target {
            background-color: #ffe6cc;
            border: 2px dashed #ff9933;
        }
        
        .seat.disabled {
            background-color: var(--disabled-color);
            border: 2px dashed #ccc;
            cursor: not-allowed;
        }
        
        .seat.disabled:hover {
            transform: none;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            background-color: var(--disabled-color);
        }
        
        .seat-number {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .seat-name {
            font-weight: bold;
            font-size: 15px;
        }
        
        .teacher-desk {
            background: linear-gradient(to bottom, var(--secondary-color), #99ccff);
            padding: 20px;
            text-align: center;
            margin-bottom: 25px;
            border-radius: 8px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-size: 1.2em;
        }
        
        .empty-seat {
            background-color: #f0f0f0;
            color: #999;
            font-style: italic;
        }
        
        .instructions {
            background-color: #fff9e6;
            border-left: 4px solid #ffcc00;
            padding: 10px 15px;
            margin: 15px 0;
            font-size: 0.9em;
            border-radius: 4px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .action-buttons button {
            flex: 1;
        }
        
        .btn-secondary {
            background-color: #a4c2f4;
        }
        
        .btn-secondary:hover {
            background-color: #7aa1f2;
        }
        
        .status-bar {
            padding: 10px;
            background-color: var(--primary-color);
            text-align: center;
            font-size: 0.9em;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }
        
        .import-feedback {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        
        .export-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .export-section button {
            flex: 1;
            min-width: 120px;
        }
        
        .theme-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .theme-config input, .theme-config select {
            margin-bottom: 0;
        }
        
        .qrcode-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            text-align: center;
        }
        
        .qrcode-container h3 {
            margin-bottom: 15px;
        }
        
        .qrcode-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 968px) {
            .panel-row {
                flex-direction: column;
            }
            
            .section {
                min-width: 100%;
            }
            
            .classroom {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 10px;
                padding: 15px;
            }
            
            .seat {
                min-width: 90px;
                min-height: 70px;
                padding: 10px 5px;
            }
            
            .area-config, .theme-config {
                grid-template-columns: 1fr;
            }
            
            .export-section button {
                min-width: 100px;
            }
        }
        
        .drag-ghost {
            position: absolute;
            background-color: var(--desk-color);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            z-index: 1000;
            opacity: 0.9;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: var(--primary-color);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .color-picker {
            height: 40px;
            padding: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>教室座位安排系统</h1>
            <p>支持导出、主题定制和高级布局选项的座位管理系统</p>
            <p>改进建议limeng@lit.edu.cn</p>
        </header>
        
        <div class="main-content">
            <div class="control-panel">
                <div class="tab-container">
                    <div class="tab active" data-tab="basic">基本设置</div>
                    <div class="tab" data-tab="advanced">高级设置</div>
                    <div class="tab" data-tab="export">导出选项</div>
                    <div class="tab" data-tab="theme">主题设置</div>
                </div>
                
                <div class="panel-row">
                    <div class="tab-content active" id="basic-tab">
                        <div class="section">
                            <h2>导入学生名单</h2>
                            <div class="instructions">
                                每行输入一个学生，格式：学号+姓名 或 仅姓名<br>
                                例如：<br>
                                1001 张三<br>
                                1002 李四<br>
                                王五
                            </div>
                            <textarea id="studentNames" placeholder="输入学生名单..." rows="5"></textarea>
                            <button id="importBtn">导入学生并安排座位</button>
                            <div id="importFeedback" class="import-feedback"></div>
                        </div>
                        
                        <div class="section">
                            <h2>座位排列方式</h2>
                            <select id="arrangeMethod">
                                <option value="number" selected>按学号顺序</option>
                                <option value="random">随机排列</option>
                                <option value="s-shape">S型排列</option>
                                <option value="reverse">倒序排列</option>
                            </select>
                            
                            <div class="action-buttons">
                                <button id="arrangeBtn">重新排列座位</button>
                                <button id="clearBtn" class="btn-secondary">清空所有座位</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="advanced-tab">
                        <div class="section">
                            <h2>教室布局设置</h2>
                            <div class="row-config">
                                <input type="number" id="rows" placeholder="行数" min="1">
                                <input type="number" id="cols" placeholder="列数" min="1">
                            </div>
                            <button id="updateLayoutBtn">更新布局</button>
                            <div class="instructions">
                                提示：留空时系统会自动计算最佳布局
                            </div>
                        </div>
                        
                        <div class="section">
                            <h2>区域设置</h2>
                            <div class="instructions">
                                设置不安排学生的区域（设置为0表示不禁用）
                            </div>
                            <div class="area-config">
                                <div>
                                    <label>前排除外行数:</label>
                                    <input type="number" id="excludeFrontRows" min="0" value="0">
                                </div>
                                <div>
                                    <label>后排除外行数:</label>
                                    <input type="number" id="excludeBackRows" min="0" value="0">
                                </div>
                                <div>
                                    <label>左列除外列数:</label>
                                    <input type="number" id="excludeLeftCols" min="0" value="0">
                                </div>
                                <div>
                                    <label>右列除外列数:</label>
                                    <input type="number" id="excludeRightCols" min="0" value="0">
                                </div>
                            </div>
                            <button id="applyAreaConfigBtn">应用区域设置</button>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="export-tab">
                        <div class="section">
                            <h2>导出座位表</h2>
                            <div class="instructions">
                                将当前座位表导出为各种格式或生成二维码
                            </div>
                            <div class="export-section">
                                <button id="exportPdfBtn">导出PDF</button>
                                <button id="exportPngBtn">导出PNG</button>
                                <button id="exportJpgBtn">导出JPG</button>
                                <button id="generateQrBtn">生成二维码</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="theme-tab">
                        <div class="section">
                            <h2>主题设置</h2>
                            <div class="instructions">
                                自定义系统外观
                            </div>
                            <div class="theme-config">
                                <div>
                                    <label>主颜色:</label>
                                    <input type="color" id="primaryColor" class="color-picker" value="#e6f2ff">
                                </div>
                                <div>
                                    <label>次要颜色:</label>
                                    <input type="color" id="secondaryColor" class="color-picker" value="#b3d9ff">
                                </div>
                                <div>
                                    <label>强调色:</label>
                                    <input type="color" id="accentColor" class="color-picker" value="#4da6ff">
                                </div>
                                <div>
                                    <label>文字颜色:</label>
                                    <input type="color" id="textColor" class="color-picker" value="#333333">
                                </div>
                                <div>
                                    <label>字体:</label>
                                    <select id="fontFamily">
                                        <option value="'Microsoft YaHei', sans-serif">微软雅黑</option>
                                        <option value="'SimSun', serif">宋体</option>
                                        <option value="'SimHei', sans-serif">黑体</option>
                                        <option value="'KaiTi', serif">楷体</option>
                                        <option value="Arial, sans-serif">Arial</option>
                                        <option value="Tahoma, sans-serif">Tahoma</option>
                                    </select>
                                </div>
                                <div>
                                    <label>字体大小:</label>
                                    <select id="fontSize">
                                        <option value="12px">小</option>
                                        <option value="14px" selected>正常</option>
                                        <option value="16px">大</option>
                                        <option value="18px">较大</option>
                                    </select>
                                </div>
                            </div>
                            <button id="applyThemeBtn">应用主题</button>
                            <button id="resetThemeBtn" class="btn-secondary">重置主题</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="seat-display">
                <div class="teacher-desk">讲台</div>
                <div class="classroom-container">
                    <div id="classroom" class="classroom">
                        <div class="empty-classroom">请导入学生名单开始安排座位</div>
                    </div>
                </div>
            </div>
            
            <div class="status-bar">
                <span id="studentCount">学生总数: 0</span>
                <span id="seatCount">座位总数: 0</span>
                <span id="availableSeatCount">可用座位: 0</span>
                <span id="statusInfo">就绪</span>
            </div>
        </div>
    </div>
    
    <div class="qrcode-overlay" id="qrcodeOverlay"></div>
    <div class="qrcode-container" id="qrcodeContainer">
        <button class="close-btn" id="closeQrcodeBtn">×</button>
        <h3>座位表二维码</h3>
        <div id="qrcode"></div>
        <p>扫描二维码查看座位表</p>
    </div>

    <script>
        // 初始化jsPDF
        const { jsPDF } = window.jspdf;
        
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const studentNamesTextarea = document.getElementById('studentNames');
            const importBtn = document.getElementById('importBtn');
            const importFeedback = document.getElementById('importFeedback');
            const arrangeMethodSelect = document.getElementById('arrangeMethod');
            const arrangeBtn = document.getElementById('arrangeBtn');
            const clearBtn = document.getElementById('clearBtn');
            const rowsInput = document.getElementById('rows');
            const colsInput = document.getElementById('cols');
            const updateLayoutBtn = document.getElementById('updateLayoutBtn');
            const excludeFrontRowsInput = document.getElementById('excludeFrontRows');
            const excludeBackRowsInput = document.getElementById('excludeBackRows');
            const excludeLeftColsInput = document.getElementById('excludeLeftCols');
            const excludeRightColsInput = document.getElementById('excludeRightCols');
            const applyAreaConfigBtn = document.getElementById('applyAreaConfigBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const exportPngBtn = document.getElementById('exportPngBtn');
            const exportJpgBtn = document.getElementById('exportJpgBtn');
            const generateQrBtn = document.getElementById('generateQrBtn');
            const primaryColorInput = document.getElementById('primaryColor');
            const secondaryColorInput = document.getElementById('secondaryColor');
            const accentColorInput = document.getElementById('accentColor');
            const textColorInput = document.getElementById('textColor');
            const fontFamilySelect = document.getElementById('fontFamily');
            const fontSizeSelect = document.getElementById('fontSize');
            const applyThemeBtn = document.getElementById('applyThemeBtn');
            const resetThemeBtn = document.getElementById('resetThemeBtn');
            const classroomDiv = document.getElementById('classroom');
            const statusInfo = document.getElementById('statusInfo');
            const studentCountSpan = document.getElementById('studentCount');
            const seatCountSpan = document.getElementById('seatCount');
            const availableSeatCountSpan = document.getElementById('availableSeatCount');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const qrcodeContainer = document.getElementById('qrcodeContainer');
            const qrcodeOverlay = document.getElementById('qrcodeOverlay');
            const closeQrcodeBtn = document.getElementById('closeQrcodeBtn');
            
            let students = [];
            let currentLayout = [];
            let nextAutoId = 1;
            let dragSourceIndex = null;
            let dragGhost = null;
            let disabledSeats = new Set();
            
            // 标签切换功能
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // 移除所有active类
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    // 添加active类到当前标签
                    tab.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // 更新状态信息
            function updateStatus(message) {
                statusInfo.textContent = message;
            }
            
            // 更新计数信息
            function updateCounts() {
                studentCountSpan.textContent = `学生总数: ${students.length}`;
                seatCountSpan.textContent = `座位总数: ${currentLayout.length}`;
                
                const availableSeats = currentLayout.length - disabledSeats.size;
                availableSeatCountSpan.textContent = `可用座位: ${availableSeats}`;
            }
            
            // 导入学生
            importBtn.addEventListener('click', function() {
                const text = studentNamesTextarea.value.trim();
                if (!text) {
                    showImportFeedback('请输入学生名单', 'error');
                    return;
                }
                
                students = [];
                nextAutoId = 1;
                const lines = text.split('\n');
                let importedCount = 0;
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue;
                    
                    const parts = trimmedLine.split(/\s+/);
                    
                    // 判断格式：有学号还是只有姓名
                    if (parts.length >= 2 && !isNaN(parts[0])) {
                        // 格式：学号 姓名
                        const id = parts[0];
                        const name = parts.slice(1).join(' ');
                        students.push({ id, name });
                        nextAutoId = Math.max(nextAutoId, parseInt(id) + 1);
                        importedCount++;
                    } else {
                        // 格式：只有姓名，自动生成学号
                        const id = nextAutoId.toString().padStart(4, '0');
                        const name = trimmedLine;
                        students.push({ id, name });
                        nextAutoId++;
                        importedCount++;
                    }
                }
                
                showImportFeedback(`成功导入 ${importedCount} 名学生`, 'success');
                updateCounts();
                autoCalculateLayout();
                arrangeStudents(arrangeMethodSelect.value);
            });
            
            // 显示导入反馈
            function showImportFeedback(message, type) {
                importFeedback.textContent = message;
                importFeedback.style.display = 'block';
                importFeedback.style.backgroundColor = type === 'success' ? '#d4edda' : '#f8d7da';
                importFeedback.style.color = type === 'success' ? '#155724' : '#721c24';
                
                // 3秒后隐藏反馈
                setTimeout(() => {
                    importFeedback.style.display = 'none';
                }, 3000);
            }
            
            // 清空座位
            clearBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有座位吗？')) {
                    currentLayout = currentLayout.map((student, index) => {
                        return disabledSeats.has(index) ? null : student;
                    });
                    updateClassroomDisplay();
                    updateStatus('已清空所有座位');
                }
            });
            
            // 自动计算最佳布局
            function autoCalculateLayout() {
                if (students.length === 0) return;
                
                // 计算合适的列数（每行座位数）
                let cols = Math.ceil(Math.sqrt(students.length * 1.5));
                if (cols < 4) cols = 4;
                if (cols > 10) cols = 10;
                
                // 计算行数
                let rows = Math.ceil(students.length / cols);
                if (rows < 3) rows = 3;
                if (rows > 8) rows = 8;
                
                // 更新输入框
                rowsInput.value = rows;
                colsInput.value = cols;
                
                // 生成教室布局
                generateClassroomLayout(rows, cols);
            }
            
            // 更新教室布局
            updateLayoutBtn.addEventListener('click', function() {
                const rows = parseInt(rowsInput.value) || 0;
                const cols = parseInt(colsInput.value) || 0;
                
                if (rows <= 0 || cols <= 0) {
                    alert('请输入有效的行数和列数');
                    return;
                }
                
                generateClassroomLayout(rows, cols);
                
                // 重新排列学生
                arrangeStudents(arrangeMethodSelect.value);
                updateStatus(`已更新布局: ${rows}行 ${cols}列`);
            });
            
            // 应用区域设置
            applyAreaConfigBtn.addEventListener('click', function() {
                if (currentLayout.length === 0) {
                    alert('请先生成教室布局');
                    return;
                }
                
                const rows = parseInt(rowsInput.value) || 0;
                const cols = parseInt(colsInput.value) || 0;
                
                if (rows <= 0 || cols <= 0) {
                    alert('请先设置有效的行数和列数');
                    return;
                }
                
                applyAreaConfig(rows, cols);
                updateStatus('已应用区域设置');
            });
            
            // 应用区域配置
            function applyAreaConfig(rows, cols) {
                const excludeFrontRows = parseInt(excludeFrontRowsInput.value) || 0;
                const excludeBackRows = parseInt(excludeBackRowsInput.value) || 0;
                const excludeLeftCols = parseInt(excludeLeftColsInput.value) || 0;
                const excludeRightCols = parseInt(excludeRightColsInput.value) || 0;
                
                // 清除之前的禁用座位
                disabledSeats.clear();
                
                // 设置新的禁用座位
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const index = r * cols + c;
                        
                        // 检查是否在前排除外行
                        if (r < excludeFrontRows) {
                            disabledSeats.add(index);
                            continue;
                        }
                        
                        // 检查是否在后排除外行
                        if (r >= rows - excludeBackRows) {
                            disabledSeats.add(index);
                            continue;
                        }
                        
                        // 检查是否在左排除外列
                        if (c < excludeLeftCols) {
                            disabledSeats.add(index);
                            continue;
                        }
                        
                        // 检查是否在右排除外列
                        if (c >= cols - excludeRightCols) {
                            disabledSeats.add(index);
                            continue;
                        }
                    }
                }
                
                // 更新座位显示
                updateClassroomDisplay();
                updateCounts();
            }
            
            // 生成教室布局
            function generateClassroomLayout(rows, cols) {
                classroomDiv.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                
                // 清除现有内容
                classroomDiv.innerHTML = '';
                
                // 初始化布局数组
                currentLayout = Array(rows * cols).fill(null);
                
                // 创建座位元素
                for (let i = 0; i < rows * cols; i++) {
                    const seat = document.createElement('div');
                    
                    if (disabledSeats.has(i)) {
                        seat.className = 'seat disabled';
                        seat.innerHTML = '<div class="seat-number">座位 ' + (i+1) + '</div><div class="seat-name">禁用</div>';
                    } else {
                        seat.className = 'seat empty-seat';
                        seat.innerHTML = '<div class="seat-number">座位 ' + (i+1) + '</div><div class="seat-name">空</div>';
                        
                        // 添加拖放事件
                        seat.addEventListener('dragstart', handleDragStart);
                        seat.addEventListener('dragover', handleDragOver);
                        seat.addEventListener('dragenter', handleDragEnter);
                        seat.addEventListener('dragleave', handleDragLeave);
                        seat.addEventListener('drop', handleDrop);
                        seat.addEventListener('dragend', handleDragEnd);
                    }
                    
                    seat.setAttribute('data-index', i);
                    classroomDiv.appendChild(seat);
                }
                
                updateCounts();
            }
            
            // 拖放事件处理
            function handleDragStart(e) {
                const seatIndex = parseInt(this.getAttribute('data-index'));
                const student = currentLayout[seatIndex];
                
                if (!student) {
                    e.preventDefault();
                    return;
                }
                
                dragSourceIndex = seatIndex;
                
                // 创建拖拽幽灵效果
                dragGhost = this.cloneNode(true);
                dragGhost.classList.add('drag-ghost');
                document.body.appendChild(dragGhost);
                e.dataTransfer.setDragImage(dragGhost, 0, 0);
                
                // 设置拖拽数据
                e.dataTransfer.setData('text/plain', student.id);
                this.classList.add('dragging');
                
                updateStatus(`正在移动: ${student.name}`);
            }
            
            function handleDragOver(e) {
                e.preventDefault();
            }
            
            function handleDragEnter(e) {
                e.preventDefault();
                this.classList.add('drop-target');
            }
            
            function handleDragLeave(e) {
                this.classList.remove('drop-target');
            }
            
            function handleDrop(e) {
                e.preventDefault();
                this.classList.remove('drop-target');
                
                const studentId = e.dataTransfer.getData('text/plain');
                const targetIndex = parseInt(this.getAttribute('data-index'));
                
                // 检查目标座位是否被禁用
                if (disabledSeats.has(targetIndex)) {
                    updateStatus('不能将学生安排到禁用座位');
                    return;
                }
                
                moveStudentToSeat(dragSourceIndex, targetIndex);
            }
            
            function handleDragEnd(e) {
                // 清理拖拽状态
                document.querySelectorAll('.seat').forEach(seat => {
                    seat.classList.remove('dragging', 'drop-target');
                });
                
                // 移除拖拽幽灵
                if (dragGhost) {
                    document.body.removeChild(dragGhost);
                    dragGhost = null;
                }
                
                dragSourceIndex = null;
                updateStatus('就绪');
            }
            
            // 移动学生到座位
            function moveStudentToSeat(fromIndex, toIndex) {
                if (fromIndex === toIndex) return;
                
                const student = currentLayout[fromIndex];
                const targetStudent = currentLayout[toIndex];
                
                if (student) {
                    // 交换座位
                    currentLayout[toIndex] = student;
                    currentLayout[fromIndex] = targetStudent;
                    
                    updateSeatDisplay(fromIndex);
                    updateSeatDisplay(toIndex);
                    
                    updateStatus(`${student.name} ${targetStudent ? `与 ${targetStudent.name} 交换了座位` : '移动了座位'}`);
                }
            }
            
            // 更新座位显示
            function updateSeatDisplay(seatIndex) {
                const seat = classroomDiv.querySelector(`[data-index="${seatIndex}"]`);
                const student = currentLayout[seatIndex];
                
                if (disabledSeats.has(seatIndex)) {
                    seat.className = 'seat disabled';
                    seat.innerHTML = '<div class="seat-number">座位 ' + (seatIndex+1) + '</div><div class="seat-name">禁用</div>';
                    return;
                }
                
                if (student) {
                    seat.className = 'seat';
                    seat.innerHTML = `<div class="seat-number">${student.id}</div><div class="seat-name">${student.name}</div>`;
                    
                    // 重新添加事件监听器（防止丢失）
                    seat.addEventListener('dragstart', handleDragStart);
                    seat.addEventListener('dragover', handleDragOver);
                    seat.addEventListener('dragenter', handleDragEnter);
                    seat.addEventListener('dragleave', handleDragLeave);
                    seat.addEventListener('drop', handleDrop);
                    seat.addEventListener('dragend', handleDragEnd);
                } else {
                    seat.className = 'seat empty-seat';
                    seat.innerHTML = '<div class="seat-number">座位 ' + (seatIndex+1) + '</div><div class="seat-name">空</div>';
                    
                    // 重新添加事件监听器
                    seat.addEventListener('dragstart', handleDragStart);
                    seat.addEventListener('dragover', handleDragOver);
                    seat.addEventListener('dragenter', handleDragEnter);
                    seat.addEventListener('dragleave', handleDragLeave);
                    seat.addEventListener('drop', handleDrop);
                    seat.addEventListener('dragend', handleDragEnd);
                }
            }
            
            // 更新整个教室显示
            function updateClassroomDisplay() {
                for (let i = 0; i < currentLayout.length; i++) {
                    updateSeatDisplay(i);
                }
            }
            
            // 应用排列方式
            arrangeBtn.addEventListener('click', function() {
                if (students.length === 0) {
                    alert('请先导入学生名单');
                    return;
                }
                
                const method = arrangeMethodSelect.value;
                arrangeStudents(method);
                updateStatus(`已应用 ${getMethodName(method)} 排列`);
            });
            
            // 获取排列方式名称
            function getMethodName(method) {
                const names = {
                    'number': '按学号顺序',
                    'random': '随机',
                    's-shape': 'S型',
                    'reverse': '倒序'
                };
                return names[method] || '未知';
            }
            
            // 排列学生
            function arrangeStudents(method) {
                if (currentLayout.length === 0) {
                    autoCalculateLayout();
                }
                
                let arrangedStudents = [];
                
                switch (method) {
                    case 'random':
                        arrangedStudents = [...students].sort(() => Math.random() - 0.5);
                        break;
                    case 'number':
                        arrangedStudents = [...students].sort((a, b) => a.id - b.id);
                        break;
                    case 's-shape':
                        arrangedStudents = arrangeSShape([...students], parseInt(rowsInput.value), parseInt(colsInput.value));
                        break;
                    case 'reverse':
                        arrangedStudents = [...students].sort((a, b) => b.id - a.id);
                        break;
                    default:
                        arrangedStudents = [...students];
                }
                
                // 重置布局（保留禁用座位）
                currentLayout = currentLayout.map((student, index) => {
                    return disabledSeats.has(index) ? null : student;
                });
                
                // 分配学生到可用座位
                let seatIndex = 0;
                for (let i = 0; i < arrangedStudents.length; i++) {
                    // 跳过禁用座位
                    while (seatIndex < currentLayout.length && disabledSeats.has(seatIndex)) {
                        seatIndex++;
                    }
                    
                    if (seatIndex >= currentLayout.length) break;
                    
                    currentLayout[seatIndex] = arrangedStudents[i];
                    seatIndex++;
                }
                
                updateClassroomDisplay();
            }
            
            // S型排列算法
            function arrangeSShape(students, rows, cols) {
                // 先按学号排序
                students.sort((a, b) => a.id - b.id);
                
                const result = [];
                const totalSeats = rows * cols;
                
                for (let i = 0; i < rows; i++) {
                    const start = i * cols;
                    
                    if (i % 2 === 0) {
                        // 偶数行：从左到右
                        for (let j = 0; j < cols; j++) {
                            const index = start + j;
                            if (index < students.length) {
                                result.push(students[index]);
                            }
                        }
                    } else {
                        // 奇数行：从右到左
                        for (let j = cols - 1; j >= 0; j--) {
                            const index = start + j;
                            if (index < students.length) {
                                result.push(students[index]);
                            }
                        }
                    }
                    
                    if (result.length >= totalSeats) break;
                }
                
                return result;
            }
            
            // 导出功能
            exportPdfBtn.addEventListener('click', exportToPdf);
            exportPngBtn.addEventListener('click', exportToPng);
            exportJpgBtn.addEventListener('click', exportToJpg);
            generateQrBtn.addEventListener('click', generateQrCode);
            
            // 导出为PDF
            function exportToPdf() {
                if (currentLayout.length === 0) {
                    alert('请先生成座位表');
                    return;
                }
                
                updateStatus('正在生成PDF...');
                
                html2canvas(classroomDiv, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('landscape', 'mm', 'a4');
                    const imgWidth = 280;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                    pdf.save('教室座位表.pdf');
                    updateStatus('PDF导出成功');
                });
            }
            
            // 导出为PNG
            function exportToPng() {
                if (currentLayout.length === 0) {
                    alert('请先生成座位表');
                    return;
                }
                
                updateStatus('正在生成PNG...');
                
                html2canvas(classroomDiv, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = '教室座位表.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    updateStatus('PNG导出成功');
                });
            }
            
            // 导出为JPG
            function exportToJpg() {
                if (currentLayout.length === 0) {
                    alert('请先生成座位表');
                    return;
                }
                
                updateStatus('正在生成JPG...');
                
                html2canvas(classroomDiv, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = '教室座位表.jpg';
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    updateStatus('JPG导出成功');
                });
            }
            
            // 生成二维码
            function generateQrCode() {
                if (currentLayout.length === 0) {
                    alert('请先生成座位表');
                    return;
                }
                
                updateStatus('正在生成二维码...');
                
                // 创建座位表文本
                let seatTableText = "教室座位表\n\n";
                seatTableText += `生成时间: ${new Date().toLocaleString()}\n\n`;
                
                const rows = parseInt(rowsInput.value) || 0;
                const cols = parseInt(colsInput.value) || 0;
                
                if (rows > 0 && cols > 0) {
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            const index = r * cols + c;
                            if (index < currentLayout.length) {
                                const student = currentLayout[index];
                                seatTableText += `座位 ${index+1}: ${student ? student.name : '空'}\t`;
                            }
                        }
                        seatTableText += "\n";
                    }
                }
                
                // 清除之前的二维码
                document.getElementById('qrcode').innerHTML = '';
                
                // 生成新二维码
                new QRCode(document.getElementById('qrcode'), {
                    text: seatTableText,
                    width: 200,
                    height: 200,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
                
                // 显示二维码弹窗
                qrcodeContainer.style.display = 'block';
                qrcodeOverlay.style.display = 'block';
                updateStatus('二维码生成成功');
            }
            
            // 关闭二维码弹窗
            closeQrcodeBtn.addEventListener('click', function() {
                qrcodeContainer.style.display = 'none';
                qrcodeOverlay.style.display = 'none';
            });
            
            // 点击遮罩层关闭二维码
            qrcodeOverlay.addEventListener('click', function() {
                qrcodeContainer.style.display = 'none';
                this.style.display = 'none';
            });
            
            // 主题设置
            applyThemeBtn.addEventListener('click', applyTheme);
            resetThemeBtn.addEventListener('click', resetTheme);
            
            // 应用主题
            function applyTheme() {
                const primaryColor = primaryColorInput.value;
                const secondaryColor = secondaryColorInput.value;
                const accentColor = accentColorInput.value;
                const textColor = textColorInput.value;
                const fontFamily = fontFamilySelect.value;
                const fontSize = fontSizeSelect.value;
                
                // 更新CSS变量
                document.documentElement.style.setProperty('--primary-color', primaryColor);
                document.documentElement.style.setProperty('--secondary-color', secondaryColor);
                document.documentElement.style.setProperty('--accent-color', accentColor);
                document.documentElement.style.setProperty('--text-color', textColor);
                document.documentElement.style.setProperty('--font-family', fontFamily);
                document.documentElement.style.setProperty('--font-size', fontSize);
                
                // 更新教师讲台背景
                document.querySelector('.teacher-desk').style.background = 
                    `linear-gradient(to bottom, ${secondaryColor}, ${lightenColor(secondaryColor, 20)})`;
                
                updateStatus('主题已应用');
            }
            
            // 重置主题
            function resetTheme() {
                primaryColorInput.value = '#e6f2ff';
                secondaryColorInput.value = '#b3d9ff';
                accentColorInput.value = '#4da6ff';
                textColorInput.value = '#333333';
                fontFamilySelect.value = "'Microsoft YaHei', sans-serif";
                fontSizeSelect.value = "14px";
                
                applyTheme();
                updateStatus('主题已重置');
            }
            
            // 颜色变亮函数
            function lightenColor(color, percent) {
                const num = parseInt(color.replace('#', ''), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) + amt;
                const G = (num >> 8 & 0x00FF) + amt;
                const B = (num & 0x0000FF) + amt;
                
                return '#' + (
                    0x1000000 +
                    (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
                    (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
                    (B < 255 ? (B < 1 ? 0 : B) : 255)
                ).toString(16).slice(1);
            }
            
            // 初始化
            updateStatus('就绪');
            updateCounts();
            
            // 添加示例数据
            studentNamesTextarea.value = "1001 张三\n1002 李四\n1003 王五\n1004 赵六\n1005 钱七\n1008 孙八\n1009 周九\n1010 吴十\n1011 郑十一\n1012 王十二";
        });
    </script>
</body>
</html>